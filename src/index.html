<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
  <!--[if lte IE 8]>
     <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
  <![endif]-->
  <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
  <script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
      <script type="text/OverpassQLTemplate" id="overpass-query-template">
        [out:json];
        (
          node(around:{rad},{lat},{lon})["amenity"~"{amenities}"];
          way(around:{rad},{lat},{lon})["amenity"~"{amenities}"];
        );
        (._;>;);
        out body;
      </script>
  </head>
<body style="margin:0">
  <div id="map" style="height: 400px;"></div>
  <div id="message" style="text-align:center;">Searching...</div>
  <script>
    function setupMap(target)
    {
        var map = L.map('map').setView([target.lat, target.lon], 13);
        var osmAttr = '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>';
        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: osmAttr
        }).addTo(map);
        var circle = L.circle([target.lat, target.lon], target.radiusMetres, {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.1
        }).addTo(map);
        return map;
    }

    function addFlag(map, lat, lon, label)
    {
        var marker = L.marker([lat, lon]);
        marker.addTo(map);
        marker.bindPopup(label || "<i>Unknown</i>");
    }

    function interpolate(low, high)
    {
        return low + ((high-low)/2.0);
    }

    function calcCentroid(way, nodes)
    {
        var node = nodes[way.nodes[0]];
        var latLow = node.lat;
        var lonLow = node.lon;
        var latHigh = node.lat;
        var lonHigh = node.lon;

        way.nodes.forEach(function(nodeIndex) {
            node = nodes[nodeIndex];
            latLow = Math.min(latLow, node.lat);
            lonLow = Math.min(lonLow, node.lon);
            latHigh = Math.max(latHigh, node.lat);
            lonHigh = Math.max(lonHigh, node.lon);
        });

        return {lat:interpolate(latLow,latHigh), lon:interpolate(lonLow, lonHigh)};
    }

    function relevant(amenitiesRE, tags)
    {
        return tags && amenitiesRE.test(tags.amenity);
    }
    
    function osmResults(map, amenitiesRE, data)
    {
        var count = 0;
        var areaNodes = {};

        data.elements.forEach(function(el) {
            if (el.type == "node")
            {
                if (el.lat && el.lon && relevant(amenitiesRE, el.tags))
                {
                    addFlag(map, el.lat, el.lon, el.tags.name);
                    ++count;
                }
                else
                {
                    areaNodes[el.id] = el;
                }
            }
            else
            {
                var loc = calcCentroid(el, areaNodes);
                if (loc && relevant(amenitiesRE, el.tags))
                {
                    addFlag(map, loc.lat, loc.lon, el.tags.name);
                    ++count;
                }
            }
        });
        $('#message').text("Found " + count + " results.");
    }

    function overpassQueryUrl(target, amenitiesRE)
    {
        var amenities = amenitiesRE.toString();
        var url = "http://overpass-api.de/api/interpreter?data=";
        var queryTemplate = $('#overpass-query-template').text();
        var query = queryTemplate.replace(/\{rad\}/g, target.radiusMetres);
        query = query.replace(/\{lat\}/g, target.lat);
        query = query.replace(/\{lon\}/g, target.lon);
        query = query.replace(/\{amenities\}/g, amenities.substring(1, amenities.length-1));
        return url + encodeURIComponent(query);
    }

    var target = { lat:55.948611, lon:-3.200833, radiusMetres:1609 };
    var amenities = /^(pub|bar)$/;
    var map = setupMap(target);

    $.ajax({
        dataType: "json",
        url: overpassQueryUrl(target, amenities),
        success: function(data) { osmResults(map, amenities, data); }
    }).fail(function() { $('#message').text("Failed."); });
  </script>
</body>
</html>
