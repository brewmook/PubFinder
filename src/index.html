<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
  <!--[if lte IE 8]>
     <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
  <![endif]-->
  <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
  <script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
      <script type="text/OverpassQL" id="overpass-query">
        [out:json];
        (
          node(around:1609,55.948611,-3.200833)["amenity"~"^(pub|bar)$"];
          way(around:1609,55.948611,-3.200833)["amenity"~"^(pub|bar)$"];
        );
        (._;>;);
        out body;
      </script>
  </head>
<body style="margin:0">
  <div id="map" style="height: 400px;"></div>
  <div id="message" style="text-align:center;">Searching...</div>
  <script>
    var target = { lat:55.948611, lon:-3.200833, radiusMetres:1609 };
    var map = L.map('map').setView([target.lat, target.lon], 13);
    var osmAttr = '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>';
    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: osmAttr
	}).addTo(map);
    var circle = L.circle([target.lat, target.lon], target.radiusMetres, {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.1
    }).addTo(map);

    function addFlag(lat, lon, label)
    {
        var marker = L.marker([lat, lon]);
        marker.addTo(map);
        marker.bindPopup(label);
    }

    function interpolate(low, high)
    {
        return low + ((high-low)/2.0);
    }

    function calcCentroid(way, nodes)
    {
        var node = nodes[way.nodes[0]];
        var latLow = node.lat;
        var lonLow = node.lon;
        var latHigh = node.lat;
        var lonHigh = node.lon;

        way.nodes.forEach(function(nodeIndex) {
            node = nodes[nodeIndex];
            latLow = Math.min(latLow, node.lat);
            lonLow = Math.min(lonLow, node.lon);
            latHigh = Math.max(latHigh, node.lat);
            lonHigh = Math.max(lonHigh, node.lon);
        });

        return {lat:interpolate(latLow,latHigh), lon:interpolate(lonLow, lonHigh)};
    }
    
    function osmResults(data)
    {
        var count = 0;
        console.log(data);
        var nodes = {};

        data.elements.forEach(function(el) {
            if (el.type == "node")
            {
                if (el.tags && el.tags.name && el.lat && el.lon)
                {
                    addFlag(el.lat, el.lon, el.tags.name);
                    ++count;
                }
                else
                {
                    nodes[el.id] = el;
                }
            }
            else
            {
                var loc = calcCentroid(el, nodes);
                if (loc && el.tags && el.tags.name)
                {
                    addFlag(loc.lat, loc.lon, el.tags.name);
                    ++count;
                }
            }
        });
        $('#message').text("Found " + count + " results.");
    }

    $.ajax({
        dataType: "json",
        url: "http://overpass-api.de/api/interpreter?data=" + encodeURIComponent($('#overpass-query').text()),
        success: osmResults
    });
  </script>
</body>
</html>
